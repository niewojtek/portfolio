#!/usr/bin/env php
<?php

    // TODO
    require("../includes/functions.php");

    // testing whether a number of arguments is right
    if ($argc != 2)
    {
        print("Usage: import /path/to/filename.txt\n");
        return 1;
    }
    
    // the path to a file
    $filename = $argv[1];

    // testing whether a file exists
    if (!file_exists($filename))
    {
       print ("The file $filename does not exist");
       return 2;
    }
    
    //  testing whether a file exists and is readable
    if (!is_readable($filename))
    {
        print("The file $filename is not readable\n");
        return 3;  
    }    

    $line = 0;
    if (($handle = fopen($filename, "r")) !== FALSE)
    {
        print("inserting data in the 'places' table...\n");
        while (($data = fgetcsv($handle, 0, "\t")) !== FALSE)
        {            
            $line++;             
            $row = [
                "country_code" => $data[0],
                "postal_code"  => $data[1],
                "place_name"   => $data[2],
                "admin_name1"  => $data[3],
                "admin_code1"  => $data[4],
                "admin_name2"  => $data[5],
                "admin_code2"  => $data[6],
                "admin_name3"  => $data[7],
                "admin_code3"  => $data[8],
                "latitude"     => $data[9],
                "longitude"    => $data[10],
                "accuracy"     => $data[11],
                "address"      => " " . $data[0] . " " . $data[1] . " " . $data[2] . " " . $data[3] . " " . $data[4] . " " . $data[5]
            ];

            // insert row into places table
            $result = query(
            "INSERT INTO places 
             (country_code, postal_code, place_name, admin_name1, admin_code1, admin_name2, admin_code2, admin_name3, admin_code3, latitude, longitude, accuracy, address)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)",
            $row["country_code"],
            $row["postal_code"],
            $row["place_name"],
            $row["admin_name1"], 
            $row["admin_code1"],
            $row["admin_name2"], 
            $row["admin_code2"],
            $row["admin_name3"], 
            $row["admin_code3"], 
            $row["latitude"], 
            $row["longitude"], 
            $row["accuracy"],
            $row["address"]);

            if ($result === false)
            {
                print("Error inserting line " . $line . "\n");
            }
           
        }

        print("   ...done. " . $line . " lines have been inserted!\n");
        // close file
        fclose($handle);
    }

?>
